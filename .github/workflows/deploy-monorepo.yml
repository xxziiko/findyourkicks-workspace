# ------------------------------------------------------------
# ğŸ§¾ Monorepo ì•± ë³€ê²½ ì‹œ Vercel ìë™ ë°°í¬
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” main ë¸Œëœì¹˜ì— ì½”ë“œê°€ push ë˜ì—ˆì„ ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
# `apps/shop` ë˜ëŠ” `apps/admin` ë””ë ‰í† ë¦¬ í˜¹ì€ ê³µí†µ íŒ¨í‚¤ì§€(`packages/shared`)ì— ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ë©´,
# í•´ë‹¹ ì•±ë§Œ ì„ íƒì ìœ¼ë¡œ ë¹Œë“œí•˜ê³  Vercelì— ë°°í¬í•©ë‹ˆë‹¤.
#
# dorny/paths-filter ì•¡ì…˜ì„ ì‚¬ìš©í•´ ë³€ê²½ëœ ê²½ë¡œë¥¼ ê°ì§€í•˜ê³ ,
# pnpm + Turborepoë¥¼ í†µí•´ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ì•± ë¹Œë“œë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
# ------------------------------------------------------------


name: Deploy Monorepo Apps

on:
  push:
    branches: [main]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    outputs:
      shop_changed: ${{ steps.filter.outputs.shop }}
      admin_changed: ${{ steps.filter.outputs.admin }}
    steps:
      - uses: actions/checkout@v3

      - name: Check changed paths
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            shop:
              - 'apps/shop/**'
              - 'packages/shared/**'
            admin:
              - 'apps/admin/**'
              - 'packages/shared/**'

  deploy-shop:
    needs: detect-changes
    if: needs.detect-changes.outputs.shop_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: ğŸŸ£ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10  

      - name: ğŸ”µ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install
      
      - name: ğŸ“ Create .env.production for shop
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=${{ env.SUPABASE_URL }}" >> apps/shop/.env.production
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ env.SUPABASE_ANON_KEY }}" >> apps/shop/.env.production

      - name: ğŸ—ï¸ Build shop app
        run: pnpm turbo run build --filter=shop...

      - name: ğŸš€ Deploy shop to Vercel
        run: vercel deploy --prod --cwd apps/shop
        
  deploy-admin:
    needs: detect-changes
    if: needs.detect-changes.outputs.admin_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: ğŸŸ£ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: ğŸ”µ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ—ï¸ Build admin app
        run: pnpm turbo run build --filter=admin...

      - name: ğŸš€ Deploy admin to Vercel
        run: vercel deploy --prod --cwd apps/admin