# ------------------------------------------------------------
# ğŸ§¾ Monorepo ì•± ë³€ê²½ ì‹œ Vercel ìë™ ë°°í¬
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” main ë¸Œëœì¹˜ì— ì½”ë“œê°€ push ë˜ì—ˆì„ ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
# `apps/shop` ë˜ëŠ” `apps/admin` ë””ë ‰í† ë¦¬ í˜¹ì€ ê³µí†µ íŒ¨í‚¤ì§€(`packages/shared`)ì— ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ë©´,
# í•´ë‹¹ ì•±ë§Œ ì„ íƒì ìœ¼ë¡œ ë¹Œë“œí•˜ê³  Vercelì— ë°°í¬í•©ë‹ˆë‹¤.
#
# dorny/paths-filter ì•¡ì…˜ì„ ì‚¬ìš©í•´ ë³€ê²½ëœ ê²½ë¡œë¥¼ ê°ì§€í•˜ê³ ,
# pnpm + Turborepoë¥¼ í†µí•´ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ì•± ë¹Œë“œë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
# ------------------------------------------------------------


name: Deploy Monorepo Apps

on:
  push:
    branches: [main]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      shop_changed: ${{ steps.filter.outputs.shop }}
      admin_changed: ${{ steps.filter.outputs.admin }}
    steps:
      - uses: actions/checkout@v3

      - name: Check changed paths
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            shop:
              - 'apps/shop/**'
              - 'packages/shared/**'
            admin:
              - 'apps/admin/**'
              - 'packages/shared/**'

  deploy-shop:
    needs: detect-changes
    if: needs.detect-changes.outputs.shop_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: pnpm install
      - run: pnpm turbo run build --filter=shop...
      - run: vercel deploy --prod --cwd apps/shop

  deploy-admin:
    needs: detect-changes
    if: needs.detect-changes.outputs.admin_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: pnpm install
      - run: pnpm turbo run build --filter=admin...
      - run: vercel deploy --prod --cwd apps/admin
      