# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§ª E2E Test CI - ë³€ê²½ëœ ì•±ë§Œ ì„ íƒì  í…ŒìŠ¤íŠ¸ ì‹¤í–‰
# 
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” PR ìƒì„± ì‹œ ë³€ê²½ëœ ì•±ë§Œì„ ê°ì§€í•˜ì—¬
# í•´ë‹¹ ì•±ì˜ E2E í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•¨ìœ¼ë¡œì¨, main ë¸Œëœì¹˜ì— ë³‘í•©ë˜ê¸° ì „
# ì‚¬ìš©ì ê²½í—˜ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì  ë¬¸ì œë¥¼ ì‚¬ì „ì— ê²€ì¦í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.
#
# ì£¼ìš” ëª©ì :
# 1. PR ìƒì„± ì‹œ ë³€ê²½ëœ ì•±ë§Œ ì„ íƒì ìœ¼ë¡œ E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
# 2. dorny/paths-filterë¥¼ í™œìš©í•œ ì •í™•í•œ ë³€ê²½ì‚¬í•­ ê°ì§€
# 3. ë³‘ë ¬ ì‹¤í–‰ìœ¼ë¡œ ì „ì²´ CI ì‹œê°„ ìµœì í™”
# 4. ì¶”í›„ ë°°í¬ ë‹¨ê³„ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì  ë¬¸ì œë¥¼ ì‚¬ì „ì— íƒì§€
# 5. ê¸°ì¡´ unified-deploy.ymlê³¼ ì¼ê´€ëœ ë³€ê²½ì‚¬í•­ ê°ì§€ íŒ¨í„´ ìœ ì§€
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: E2E Test CI

on:
  pull_request:


jobs:

  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      shop_changed: ${{ steps.filter.outputs.shop }}
      admin_changed: ${{ steps.filter.outputs.admin }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            shop:
              - 'apps/shop/**'
              - 'packages/shared/**'
            admin:
              - 'apps/admin/**'
              - 'packages/shared/**'

  # Shop ì•± E2E í…ŒìŠ¤íŠ¸ 
  e2e-test-shop:
    needs: detect-changes
    if: needs.detect-changes.outputs.shop_changed == 'true'
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: â¬‡ Checkout repository
        uses: actions/checkout@v3

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ­ Setup Playwright
        run: pnpm exec playwright install --with-deps

      - name: ï¿½ï¿½ Run Shop E2E tests
        working-directory: apps/shop
        run: pnpm exec playwright test


  # Admin ì•± E2E í…ŒìŠ¤íŠ¸ 
  e2e-test-admin:
    needs: detect-changes
    if: needs.detect-changes.outputs.admin_changed == 'true'
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: â¬‡ Checkout repository
        uses: actions/checkout@v3

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ­ Setup Playwright
        run: pnpm exec playwright install --with-deps

      - name: ğŸ§ª Run Admin E2E tests
        working-directory: apps/admin
        run: |
          if [ -f "package.json" ] && grep -q "playwright" "package.json"; then
            pnpm exec playwright test
          else
            echo "No Playwright tests found for admin app"
          fi
